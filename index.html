<!DOCTYPE html>
<html>
    <head>
        <title id="title">お食事処 掲示板</title>
        <meta charset="utf-8" />
        <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
        <!-- Make sure you put this AFTER Leaflet's CSS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    </head>

    <body>
    <h1 style="text-align: center;">お食事処 掲示板</h1>
    <div id="map"></div>

    <?!= include('map.html'); ?>
    <?!= include('css.html'); ?>
    </body>

    <div class="tab" style="width: 600px;">

      <!-- 初期状態で表示されるコンテンツに対応するラジオボタンにはchecked="checkedを設定する -->
      <input id="menu1" class="tab-input" name="menu" type="radio" checked="checked">
      <label for="menu1" class="tab-item">登録</label>
      <div class="tab-content">
        <div style="text-align: center; margin: 20px;">
          <h4>お店の登録</h4>
          <div>店名検索</div>
          <input type="text" name="register" placeholder="店名" id="registerDataName">
          <button onclick="registerSearchName()">検索</button>
          <div>電話番号検索</div>
          <input type="text" name="register" placeholder="電話番号" id="registerDataTel">
          <button onclick="registerSearchTel()">検索</button>          
          <div id="checkdata"></div>
          <div id="notfound1"></div>
        </div>
      </div>

      <input id="menu2" class="tab-input" name="menu" type="radio">
      <label for="menu2" class="tab-item">ランダム</label>
      <div class="tab-content">
        <div style="text-align: center; margin: 20px;">
          <h4>ランダムお店選び機能</h4>
          <input type="text" name="search" placeholder="キーワードを入力" id="randomKeyword">
          <button onclick="randomSearch()">スタート</button>
          <div id="notfound2"></div>
        </div>
      </div>

      <input id="menu3" class="tab-input" name="menu" type="radio">
      <label for="menu3" class="tab-item">削除</label>
      <div class="tab-content">
        <div style="text-align: center; margin: 20px;">
          <h4>あなたの記録</h4>
            <table class="content-table" >
              <thead>
                <th>店名</th>
                <th>コメント</th>
                <th>ボタン</th>
              </thead>
              <tbody id="myTable"></tbody>
            </table>
          <div id="notfound3"></div>
        </div>
      </div>

    </div>   

    <table class="content-table">
      <thead>
        <tr>
          <th>店名</th>
          <th>キャッチコピー</th>
          <th>サイト</th>
        </tr>
      </thead>
      <tbody id="playerList"></tbody>  <!-- ここに配列の中身を表示させる -->
    </table>

    <dialog id="registerdialog">

      <h2 style="text-align: center">登録フォーム</h2>

      <div class="row">
        <label for="storename">店名:</label>
        <div id="storename" value="storename"></div>
      </div>
        
      <div class="row">
        <label for="comment">コメント:</label>
        <textarea id="comment" name="comment"></textarea>
      </div>

      <div class="row">
        <label for="release">全体公開:</label>
        <input type="radio" id="releaseChoice1" name="releasechk" value="releaseok" checked>
        <label for="releaseChoice1">する</label>
        <input type="radio" id="releaseChoice2" name="releasechk" value="releaseng">
        <label for="releaseChoice2">しない</label>
      </div>

      <menu style="text-align: center">
        <button id="cancel" type="reset" onclick="closeDialog('#registerdialog')">キャンセル</button>
        <button id="confirm" type="submit" onclick="registerData()">登録</button>
      </menu>

    </dialog>

    <dialog id="successdialog">
      <h2 style="text-align: center">登録が完了しました。</h2>
      <h4 style="text-align: center">ページを再読み込みしてください。</h4>
    </dialog>

    <dialog id="failuredialog">
      <h2 style="text-align: center">予期せぬエラーで登録が失敗しました。</h2>
      <h4 style="text-align: center">管理者にお問い合わせください。</h4>
    </dialog>

    //データ削除確認ダイアログ
    <dialog id="deletecheckdialog">
      <h2 style="text-align: center">本当に削除しますか?</h2>
      <menu id="deletebutton" style="text-align: center">
        <!--<button id="deletecancel" type="reset" onclick="closeDialog('#deletecheckdialog')">キャンセル</button>
        <button id="deleteconfirm" type="submit" onclick="deleteData()">削除</button>-->
      </menu>
    </dialog>

    <dialog id="storeinfodialog">

      <div class="row">
        <label for="storenamemap">店名:</label>
        <div id="storenamemap" value="storenamemap"></div>
      </div>

      <div class="row">
        <label for="storeaddress">住所:</label>
        <div id="storeaddress" value="storeaddress"></div>
      </div>

      <div class="row">
        <label for="storestation">最寄り駅:</label>
        <div id="storestation" value="storestation"></div>
      </div>

      <div class="row">
        <label for="storecomment">コメント:</label>
        <div id="storecomment" value="storecomment"></div>
      </div>

      <menu style="text-align: center">
        <button id="cancel" type="reset" onclick="closeDialog('#storeinfodialog')">閉じる</button>
      </menu>
  
    </dialog>
    
    <script>
      function createTable(){
          console.log("CreateTable");
          console.log("配列",loginUserData);
          const table = document.getElementById("myTable");
          let button;
          const order = ["name", "comment", "button"];    
          console.log(loginUserData.length);
          console.log(order.length);    
          for(let i = 0; i < loginUserData.length; i++){
              const tr = document.createElement("tr");
              table.appendChild(tr);
              for(let j = 0; j < order.length; j++){
                  const td = document.createElement("td");
                  if(order[j] === "button"){
                      button = '<button name="button" onclick="deleteUserDataDialog(\'' + loginUserData[i]["id"] + '\')">削除</button>';
                      td.innerHTML = button;
                  } else {
                      td.textContent = loginUserData[i][order[j]];
                  }
                  tr.appendChild(td);
              }
          }
      }
    </script>

    <script>
        let activeTag;
        let falseTag;

        function registerSearchName(){
            activeTag = 'registerDataName';
            falseTag = 'notfound1';
            let keyword = document.getElementById('registerDataName').value.replace(/　/g," ");
            console.log(keyword);
            let comment = document.getElementById('comment');
            comment.value = "";
            google.script.run.withSuccessHandler(displayAPIResult).withFailureHandler(handleError).getRegisterSearch(keyword,"name");
        }

        function registerSearchTel(){
            activeTag = 'registerDataTel';
            falseTag = 'notfound1';
            let keyword = document.getElementById('registerDataTel').value.replace(/　/g," ");
            let comment = document.getElementById('comment');
            comment.value = "";
            google.script.run.withSuccessHandler(displayAPIResult).withFailureHandler(handleError).getRegisterSearch(keyword,"tel");
        }

        function randomSearch(){
            activeTag = 'randomKeyword';
            falseTag = 'notfound2';
            let keyword = document.getElementById(activeTag).value.replace(/　/g," ");//全角スペースを半角スペースに;
            //let keyword = "品川";
            console.log(keyword);
            google.script.run.withSuccessHandler(displayAPIResult).withFailureHandler(handleError).getRandomSearch(keyword);
        }

        function registerData(){
            let storename = document.getElementById('storename').innerText;
            let comment = document.getElementById('comment').value;
            let releaseCheck = document.getElementsByName('releasechk');
            let checkValue = "";
            for(let i = 0; i < releaseCheck.length; i++){
                if(releaseCheck.item(i).checked){
                    checkValue = releaseCheck.item(i).value;
                }
            }
            google.script.run.withSuccessHandler(displayRegisterResult).withFailureHandler(handleError).reflectionData(storename,comment,checkValue);
        }

        function handleError(error) {
            console.log("エラーが発生しました:", error);
        }

    </script>

    <script>
      // APIの結果を表示する関数
      function displayAPIResult(apiResult) {
          const playerList = document.getElementById("playerList");
          const order = ["name", "catch", "urls"];
          console.log(apiResult);
          const falseDiv = document.getElementById(falseTag);
          if(!apiResult){
              falseDiv.innerHTML = '<h5>キーワード : '+document.getElementById(activeTag).value+'では見つかりませんでした...</h5>';
          } else {
              falseDiv.innerHTML ="";
              for(let i = 0; i < apiResult.length; i++){
                  const tr = document.createElement("tr");
                  playerList.appendChild(tr);  
                  for(let j = 0; j < order.length; j++){
                      const td = document.createElement("td");
                      if(order[j] === "urls"){
                          td.innerHTML = "<a href='"+apiResult[i][order[j]]+"' target='_blank'>リンク</a>";
                      } else {
                          td.textContent = apiResult[i][order[j]];
                      }
                      console.log(apiResult[i][order[j]],i,j);
                      tr.appendChild(td);
                  }
              }

              if(activeTag.includes('registerData')){
                  const checkDiv = document.getElementById("checkdata");
                  checkDiv.innerHTML = '<h5>登録する店は '+apiResult[0]["name"]+' で合っていますか?</h5>';
                  checkDiv.innerHTML += '<button onclick="showDialog()">OK</button>';
                  const storenameDiv = document.getElementById("storename");
                  storenameDiv.innerHTML = apiResult[0]["name"];
              } 
        }
      }

      //登録完了を表示
      function displayRegisterResult(apiResult){
        //console.log(apiResult);
        let dialog = document.querySelector('#registerdialog');
        dialog.close();
        let resultdialog = "";
        if(apiResult){
            resultdialog = document.querySelector('#successdialog');
        } else {
            resultdialog = document.querySelector('#failuredialog');
        }
        resultdialog.showModal();
      }

      function showDialog(){
        let dialog = document.querySelector('#registerdialog');
        dialog.showModal();
      }

      function closeDialog(id){
        let dialog = document.querySelector(id);
        dialog.close();
      }

      function buttonClick(buttonId) {
        console.log('ボタン ' + buttonId + ' が押されました！');
        // ここで必要な処理を行う
        for(let i = 0; i < mapData.length; i++){
            if (mapData[i]["id"] === buttonId){
                let dialog = document.querySelector('#storeinfodialog');
                const storenameDiv = document.getElementById("storenamemap");
                storenameDiv.innerHTML = "<a href='" + mapData[i]['link'] + "' target='_blank'>" + mapData[i]["name"] + "</a>";
                const storeaddressDiv = document.getElementById("storeaddress");
                storeaddressDiv.innerHTML = mapData[i]["address"];
                const storestationDiv = document.getElementById("storestation");
                storestationDiv.innerHTML = mapData[i]["station"];
                const storecommentDiv = document.getElementById("storecomment");
                storecommentDiv.innerHTML = "・"+ mapData[i]["comment"];
                dialog.showModal();
            };
        }
      }

      function deleteUserDataDialog(id) {
        console.log('ボタン ' + id + ' が押されました！',"削除");
        let dialog = document.querySelector('#deletecheckdialog');
        const checkDiv = document.getElementById("deletebutton");
        checkDiv.innerHTML = '<button id="deletecancel" type="reset" onclick="closeDialog(\'#deletecheckdialog\')">キャンセル</button>';
        checkDiv.innerHTML += '<button name="button" onclick="deleteData(\'' + id + '\')">削除</button>';
        dialog.showModal();
      }

      function deleteData(id) {
        console.log(id)
      }

    </script>

</html>