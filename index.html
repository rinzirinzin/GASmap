<!DOCTYPE html>
<html>
    <head>
        <title id="title">お食事処 掲示板</title>
        <meta charset="utf-8" />
        <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
        <!-- Make sure you put this AFTER Leaflet's CSS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    </head>

    <body>
    <h1 style="text-align: center;">お食事処 掲示板</h1>
    <div id="map"></div>

    <?!= include('map.html'); ?>
    <?!= include('css.html'); ?>
    

    <div class="tab">

      <!-- 初期状態で表示されるコンテンツに対応するラジオボタンにはchecked="checkedを設定する -->
      <input id="menu1" class="tab-input" name="menu" type="radio" checked="checked">
      <label for="menu1" class="tab-item">登録</label>
      <div class="tab-content">
        <div style="text-align: center; margin: 20px;">
          <h4>お店の登録</h4>
          <div>店名検索</div>
          <input type="text" name="register" placeholder="店名" id="registerDataName">
          <button onclick="registerSearchName()">検索</button>
          <div>電話番号検索</div>
          <input type="text" name="register" placeholder="電話番号" id="registerDataTel">
          <button onclick="registerSearchTel()">検索</button>          
          <div id="checkdata"></div>
          <div id="notfound1"></div>
        </div>
      </div>

      <input id="menu2" class="tab-input" name="menu" type="radio">
      <label for="menu2" class="tab-item">ランダム</label>
      <div class="tab-content">
        <div style="text-align: center; margin: 20px;">
          <h4>ランダムお店選び機能</h4>
          <input type="text" name="search" placeholder="キーワードを入力" id="randomKeyword">
          <button onclick="randomSearch()">スタート</button>
          <div id="notfound2"></div>
        </div>
      </div>

      <input id="menu3" class="tab-input" name="menu" type="radio">
      <label for="menu3" class="tab-item">削除</label>
      <div class="tab-content">コンテンツ3
      </div>

    </div>   

    <table class="content-table">
      <thead>
        <tr>
          <th>店名</th>
          <th>キャッチコピー</th>
          <th>サイト</th>
        </tr>
      </thead>
      <tbody id="playerList"></tbody>  <!-- ここに配列の中身を表示させる -->
    </table>

    <dialog id="registerdialog">

        <h2 style="text-align: center">登録フォーム</h2>

        <div class="row">
          <label for="storename">店名:</label>
          <div id="storename" value="storename"></div>
        </div>
        
        <div class="row">
          <label for="comment">コメント:</label>
          <textarea id="comment" name="comment"></textarea>
        </div>

        <div class="row">
          <label for="release">全体公開:</label>
          <input type="radio" id="releaseChoice1" name="releasechk" value="releaseok" checked>
          <label for="releaseChoice1">する</label>
          <input type="radio" id="releaseChoice2" name="releasechk" value="releaseng">
          <label for="releaseChoice2">しない</label>
        </div>

        <menu style="text-align: center">
          <button id="cancel" type="reset" onclick="closeDialog()">キャンセル</button>
          <button id="confirm" type="submit" onclick="registerData()">登録</button>
        </menu>

    </dialog>

    <script>
        let activeTag;
        let falseTag;

        function registerSearchName(){
            activeTag = 'registerDataName';
            falseTag = 'notfound1';
            let keyword = document.getElementById('registerDataName').value.replace(/　/g," ");
            console.log(keyword);
            let comment = document.getElementById('comment');
            comment.value = "";
            google.script.run.withSuccessHandler(displayAPIResult).withFailureHandler(handleError).getRegisterSearch(keyword,"name");
        }

        function registerSearchTel(){
            activeTag = 'registerDataTel';
            falseTag = 'notfound1';
            let keyword = document.getElementById('registerDataTel').value.replace(/　/g," ");
            let comment = document.getElementById('comment');
            comment.value = "";
            google.script.run.withSuccessHandler(displayAPIResult).withFailureHandler(handleError).getRegisterSearch(keyword,"tel");
        }

        function randomSearch(){
            activeTag = 'randomKeyword';
            falseTag = 'notfound2';
            let keyword = document.getElementById(activeTag).value.replace(/　/g," ");//全角スペースを半角スペースに;
            //let keyword = "品川";
            console.log(keyword);
            google.script.run.withSuccessHandler(displayAPIResult).withFailureHandler(handleError).getRandomSearch(keyword);
        }

        function registerData(){
            let storename = document.getElementById('storename').innerText;
            let comment = document.getElementById('comment').value;
            let releaseCheck = document.getElementsByName('releasechk');
            let checkValue = "";
            for(let i = 0; i < releaseCheck.length; i++){
                if(releaseCheck.item(i).checked){
                    checkValue = releaseCheck.item(i).value;
                }
            }
            console.log("デバッグ");
            console.log(storename);
            console.log(comment);
            console.log(checkValue);
            google.script.run.withSuccessHandler(displayRegisterResult).withFailureHandler(handleError).reflectionData(storename,comment,checkValue);
            console.log("なぜここに")
        }

        function handleError(error) {
            console.log("エラーが発生しました:", error);
        }

    </script>

    <script>
      // APIの結果を表示する関数
      function displayAPIResult(apiResult) {
        const playerList = document.getElementById("playerList");
        const order = ["name", "catch", "urls"];
        console.log(apiResult);
        const falseDiv = document.getElementById(falseTag);
        if(!apiResult){
          falseDiv.innerHTML = '<h5>キーワード : '+document.getElementById(activeTag).value+'では見つかりませんでした...</h5>';
        }else{
          falseDiv.innerHTML ="";
          for(let i = 0; i < apiResult.length; i++){
            const tr = document.createElement("tr");
            playerList.appendChild(tr);  
            for(let j = 0; j < order.length; j++){
                const td = document.createElement("td");
                if(order[j] === "urls"){
                  td.innerHTML = "<a href='"+apiResult[i][order[j]]+"' target='_blank'>リンク</a>";
                }
                else {
                  td.textContent = apiResult[i][order[j]];
                }
                console.log(apiResult[i][order[j]],i,j);
                tr.appendChild(td);
            }
          }

          if(activeTag.includes('registerData')){
            const checkDiv = document.getElementById("checkdata");
            checkDiv.innerHTML = '<h5>登録する店は '+apiResult[0]["name"]+' で合っていますか?</h5>';
            checkDiv.innerHTML += '<button onclick="showDialog()">OK</button>';
            const storenameDiv = document.getElementById("storename");
            storenameDiv.innerHTML = apiResult[0]["name"];
            //ダイアログ表示ボタンでも載せておく。
          } 
        }
      }

      //登録完了を表示
      function displayRegisterResult(apiResult){
        console.log(apiResult);
      }

      function showDialog(){
        let dialog = document.querySelector('#registerdialog');
        dialog.showModal();
      }

      function closeDialog(){
        let dialog = document.querySelector('#registerdialog');
        dialog.close();
      }

    </script>

    </body>
</html>